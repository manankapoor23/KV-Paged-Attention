<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KV-Paged Attention Visualizer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-layout">
        <!-- Left Sidebar: Chat History -->
        <aside class="chat-sidebar">
            <div class="sidebar-header">
                <h2>Simulations</h2>
                <button id="clear-history-btn" class="btn-icon" title="Clear all">✕</button>
            </div>
            <div class="chat-list" id="chat-list"></div>
        </aside>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <h1>KV-Paged Attention Visualizer</h1>
                <p>Visualizing how LLMs manage memory during inference</p>
            </header>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="input-section">
                    <label for="prompt-input">Prompt</label>
                    <input
                        type="text"
                        id="prompt-input"
                        placeholder="e.g., You are a helpful assistant"
                        value="You are a helpful"
                    />
                    <button id="run-btn" class="btn-primary">Run Simulation</button>
                    <div id="status" class="status"></div>
                </div>

                <div class="pipeline" aria-label="Mental model pipeline">
                    <span class="pipeline-node">Text</span>
                    <span class="pipeline-arrow">→</span>
                    <span class="pipeline-node">Tokens</span>
                    <span class="pipeline-arrow">→</span>
                    <span class="pipeline-node">Page Table</span>
                    <span class="pipeline-arrow">→</span>
                    <span class="pipeline-node">KV Pages</span>
                    <span class="pipeline-arrow">→</span>
                    <span class="pipeline-node">Attention</span>
                </div>
            </div>

            <!-- Main Visualization Area -->
        <div class="visualization-area" id="viz-area" style="display: none;">
            <!-- Current Request Info -->
            <div class="request-info">
                <span id="request-display" class="request-label">Simulation</span>
                <span id="event-count" class="request-meta"></span>
            </div>
            <!-- Timeline + Narration (Primary Focus) -->
            <section class="timeline-narration" aria-label="Timeline and narration">
                <div class="timeline-top">
                    <div id="timeline-label" class="step-label">Step 0 / 0</div>
                    <input
                        type="range"
                        id="timeline-slider"
                        min="0"
                        max="100"
                        value="0"
                        class="slider"
                        aria-label="Simulation step"
                    />
                    <button id="play-btn" class="btn-ghost" type="button" aria-label="Play">Play</button>
                </div>
                <div class="timeline-divider"></div>
                <div class="narration-block">
                    <div class="narration-title">What’s happening</div>
                    <div id="narration-text" class="narration-content">
                        <p>Run a simulation, then scrub the timeline to replay events.</p>
                    </div>
                </div>
            </section>

            <!-- Main Visualization Area (3 columns) -->
            <section class="main-viz" aria-label="Main visualization">
                <div class="panel">
                    <div class="panel-header">Tokens</div>
                    <div class="panel-body" id="tokens-list"></div>
                </div>

                <div class="panel">
                    <div class="panel-header">Page Table</div>
                    <div class="panel-body" id="page-table"></div>
                </div>

                <div class="panel">
                    <div class="panel-header">KV Pages</div>
                    <div class="panel-body">
                        <div id="pages-grid" class="pages-grid"></div>
                        <div class="kv-legend" aria-label="KV legend">
                            <span class="kv-legend-item"><span class="kv-box filled"></span> occupied</span>
                            <span class="kv-legend-item"><span class="kv-box"></span> free</span>
                            <span class="kv-legend-item"><span class="kv-box just-written"></span> newly written</span>
                            <span class="kv-legend-item"><span class="kv-pill shared"></span> shared</span>
                            <span class="kv-legend-item"><span class="kv-pill freed"></span> freed</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Attention View (collapsible) -->
            <details class="collapsible" id="attention-details">
                <summary>Attention View</summary>
                <div class="collapsible-body" id="attention-view">
                    <div class="hint">
                        This demo doesn’t expose per-token attention weights. This panel explains how attention reads from KV pages:
                        recent tokens tend to contribute more, and those tokens live in specific pages/slots.
                    </div>
                    <div id="attention-bars" class="attention-bars"></div>
                </div>
            </details>

            <!-- Event Log (collapsible, secondary) -->
            <details class="collapsible" id="eventlog-details">
                <summary>Event Log</summary>
                <div class="collapsible-body">
                    <div id="events-list" class="events-list"></div>
                </div>
            </details>
        </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="visualizer.js"></script>
    <script src="main.js"></script>
</body>
</html>
